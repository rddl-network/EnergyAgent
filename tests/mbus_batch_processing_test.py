import json
import pytest
from app.energy_agent.smart_meter_reader.mbus_reader import MbusReader
from app.energy_agent.smart_meter_reader.mbus_frame import DLMSFrame
from app.energy_agent.smart_meter_reader.dlms_parser import DSMRParser
from app.energy_agent.smart_meter_reader.lg_e450 import parse_e450_meter_data

from app.energy_agent.energy_decrypter import (
    decrypt_aes_gcm_landis_and_gyr,
    decrypt_gcm,
    unwrap_apdu,
    decrypt_evn_data,
)

frames = [
    "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e8c3f44d3b65fcf023f403e19036a1c9f5e6eabdf04c40a4800b1509a2252881267d0b90e585eef07f57c90ad75192893725ae5f06bacee5a422d33f1705a1919765812e06910abfdb2beb901270657e",
    "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e8cacbb3176bfb6d62b4340d8f1faed60d316317766f277899e0f285282779d1acf4b02960dd76d66210a77bddfb19338ce2ca4f41a083737cefc2d0134b3a5194c2656cc2647be83a21acaf1c17287e",
    "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e8caca3a52a875c7500f842da0ca6ac1d98c0abbf61ed49e3d6eb3d4ff133324b53371759b9a470b0ce2c1efeb8c20179cdb68b14b7bd6540cb596c91382e18b88bc04ecdc3104dadaeb5dbfa074cb7e",
    "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e8cac64953ac1f7aa3185c28b0642bd7bdf041628d27348f232b39484030207c9a272f68945a771960d72c2bef6d22660416c9e05436aecaa6167fe63b85473505cd4bfaadb477fd120be1ef9552d97e",
    "7ea08bceff0313eee1e6e700e0400001000077db084c475a67737c7e8e820103300009833108abce90b04deb2c46f68ae7d8e04f42404131bb25d50be0de4b6c81c6bcb7f094c2f9cf41f85dae692eefd67d74a1c12045fc673e72143da1ea280d7b38751e33a38af80d5b641c2b9025dfa64d2ad115064af080086a141563f5056caf7b3a99595f904ef3527e",
    "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e87ea30fed7047d500c157a153258f4101eb0a5b892f58f62805ce0873f696990b95df9c45f40e3845d5e279cc33073504285e5d98a1c24a3efdf066cf1f1420f5da462b6410ebbd7896daad93a9d87e",
    "7ea08bceff0313eee1e6e700e0400001000077db084c475a677362f13a8201c53000b1cdb52ec1eb626fde9e6d337047190e0cb1ca7f6d681d0dbede752c685dadf86382cf4ea66bb1890e11fdb1eb87090db5fc451603362da0ce529e57cb0be9e3af314e61ef3c3ea7ec236dcc3846bacd3256c98a220165fcc30696c7a8a3b44114b87c816b760d420ae57e"
    "7ea08bceff0313eee1e040000200007a474c319e92d674b21117089bb4c52b7cc551eaf3052a2892fcdd95c48bedf90d5d521cfe4b3cc4f3b974c865d9116d5208e19831d869db3a1d6609e4a54c43c9b9504495a43e21f5b344c462d5e79e9f1416484f359a0cc56ac0a1bae8445144bee3a7aa7e8320b36a2703374a6441cb307430c13d0ae891b80307197e"
    "7ea08bceff0313eee1e040000300007a68e7626e0f7045185945483038efd0520c05ff5179f8e0090ae86317718fa4f09666f7609b365a72bb82e655242c3fdb7c9aa86c9de78346fc62a92a8bc421c9aaef15bf786b09035a8d95de21c38a56a5e01dd2308ef2b949aa89c8a53c3d1d8e609ac6e026a8f9eb79d597983a2b519b24cbce415c74947893a5257e"
    "7ea078ceff03138463e0c00004000067a0c6fc1db0926f2ec72fc115bb4f8ff217c356a2752c1c0ef4195e1c5312ab0d23e2535cffc6bd4a0c9f002c753b05ac313888a81021e52c248cebf3c566639b6e82755d6abd1da2b4ca707812cdb9c44e4688c957c9d9c488705d0e098b41d6096d259ebde315dd0d7e",
]


frames_data = [
    {
        "frame_id": 1,
        "frame": "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e8c3f44d3b65fcf023f403e19036a1c9f5e6eabdf04c40a4800b1509a2252881267d0b90e585eef07f57c90ad75192893725ae5f06bacee5a422d33f1705a1919765812e06910abfdb2beb901270657e",
        "length": [90],
        "num_frames": 1,
        "data": [
            "db084c475a6773745ddd4f2000e8c3f44d3b65fcf023f403e19036a1c9f5e6eabdf04c40a4800b1509a2252881267d0b90e585eef07f57c90ad75192893725ae5f06bacee5a422d33f1705a1919765812e06910abfdb2beb9012"
        ],
    },
    {
        "frame_id": 2,
        "frame": "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e8cacbb3176bfb6d62b4340d8f1faed60d316317766f277899e0f285282779d1acf4b02960dd76d66210a77bddfb19338ce2ca4f41a083737cefc2d0134b3a5194c2656cc2647be83a21acaf1c17287e",
        "length": [90],
        "num_frames": 1,
        "data": [
            "db084c475a6773745ddd4f2000e8cacbb3176bfb6d62b4340d8f1faed60d316317766f277899e0f285282779d1acf4b02960dd76d66210a77bddfb19338ce2ca4f41a083737cefc2d0134b3a5194c2656cc2647be83a21acaf1c"
        ],
    },
    {
        "frame_id": 3,
        "frame": "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e8caca3a52a875c7500f842da0ca6ac1d98c0abbf61ed49e3d6eb3d4ff133324b53371759b9a470b0ce2c1efeb8c20179cdb68b14b7bd6540cb596c91382e18b88bc04ecdc3104dadaeb5dbfa074cb7e",
        "length": [90],
        "num_frames": 1,
        "data": [
            "db084c475a6773745ddd4f2000e8caca3a52a875c7500f842da0ca6ac1d98c0abbf61ed49e3d6eb3d4ff133324b53371759b9a470b0ce2c1efeb8c20179cdb68b14b7bd6540cb596c91382e18b88bc04ecdc3104dadaeb5dbfa0"
        ],
    },
    {
        "frame_id": 4,
        "frame": "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e8cac64953ac1f7aa3185c28b0642bd7bdf041628d27348f232b39484030207c9a272f68945a771960d72c2bef6d22660416c9e05436aecaa6167fe63b85473505cd4bfaadb477fd120be1ef9552d97e",
        "length": [90],
        "num_frames": 1,
        "data": [
            "db084c475a6773745ddd4f2000e8cac64953ac1f7aa3185c28b0642bd7bdf041628d27348f232b39484030207c9a272f68945a771960d72c2bef6d22660416c9e05436aecaa6167fe63b85473505cd4bfaadb477fd120be1ef95"
        ],
    },
    {
        "frame_id": 5,
        "frame": "7ea08bceff0313eee1e6e700e0400001000077db084c475a67737c7e8e820103300009833108abce90b04deb2c46f68ae7d8e04f42404131bb25d50be0de4b6c81c6bcb7f094c2f9cf41f85dae692eefd67d74a1c12045fc673e72143da1ea280d7b38751e33a38af80d5b641c2b9025dfa64d2ad115064af080086a141563f5056caf7b3a99595f904ef3527e",
        "length": [119],
        "num_frames": 1,
        "data": [
            "db084c475a67737c7e8e820103300009833108abce90b04deb2c46f68ae7d8e04f42404131bb25d50be0de4b6c81c6bcb7f094c2f9cf41f85dae692eefd67d74a1c12045fc673e72143da1ea280d7b38751e33a38af80d5b641c2b9025dfa64d2ad115064af080086a141563f5056caf7b3a99595f904e"
        ],
    },
    {
        "frame_id": 6,
        "frame": "7ea067ceff031338bde6e700db084c475a6773745ddd4f2000e87ea30fed7047d500c157a153258f4101eb0a5b892f58f62805ce0873f696990b95df9c45f40e3845d5e279cc33073504285e5d98a1c24a3efdf066cf1f1420f5da462b6410ebbd7896daad93a9d87e",
        "length": [90],
        "num_frames": 1,
        "data": [
            "db084c475a6773745ddd4f2000e87ea30fed7047d500c157a153258f4101eb0a5b892f58f62805ce0873f696990b95df9c45f40e3845d5e279cc33073504285e5d98a1c24a3efdf066cf1f1420f5da462b6410ebbd7896daad93"
        ],
    },
    {
        "frame_id": 7,
        "frame": "7ea08bceff0313eee1e6e700e0400001000077db084c475a677362f13a8201c53000b1cdb52ec1eb626fde9e6d337047190e0cb1ca7f6d681d0dbede752c685dadf86382cf4ea66bb1890e11fdb1eb87090db5fc451603362da0ce529e57cb0be9e3af314e61ef3c3ea7ec236dcc3846bacd3256c98a220165fcc30696c7a8a3b44114b87c816b760d420ae57e"
        "7ea08bceff0313eee1e040000200007a474c319e92d674b21117089bb4c52b7cc551eaf3052a2892fcdd95c48bedf90d5d521cfe4b3cc4f3b974c865d9116d5208e19831d869db3a1d6609e4a54c43c9b9504495a43e21f5b344c462d5e79e9f1416484f359a0cc56ac0a1bae8445144bee3a7aa7e8320b36a2703374a6441cb307430c13d0ae891b80307197e"
        "7ea08bceff0313eee1e040000300007a68e7626e0f7045185945483038efd0520c05ff5179f8e0090ae86317718fa4f09666f7609b365a72bb82e655242c3fdb7c9aa86c9de78346fc62a92a8bc421c9aaef15bf786b09035a8d95de21c38a56a5e01dd2308ef2b949aa89c8a53c3d1d8e609ac6e026a8f9eb79d597983a2b519b24cbce415c74947893a5257e"
        "7ea078ceff03138463e0c00004000067a0c6fc1db0926f2ec72fc115bb4f8ff217c356a2752c1c0ef4195e1c5312ab0d23e2535cffc6bd4a0c9f002c753b05ac313888a81021e52c248cebf3c566639b6e82755d6abd1da2b4ca707812cdb9c44e4688c957c9d9c488705d0e098b41d6096d259ebde315dd0d7e",
        "length": [119, 122, 122, 103],
        "num_frames": 4,
        "data": [
            "db084c475a677362f13a8201c53000b1cdb52ec1eb626fde9e6d337047190e0cb1ca7f6d681d0dbede752c685dadf86382cf4ea66bb1890e11fdb1eb87090db5fc451603362da0ce529e57cb0be9e3af314e61ef3c3ea7ec236dcc3846bacd3256c98a220165fcc30696c7a8a3b44114b87c816b760d42",
            "474c319e92d674b21117089bb4c52b7cc551eaf3052a2892fcdd95c48bedf90d5d521cfe4b3cc4f3b974c865d9116d5208e19831d869db3a1d6609e4a54c43c9b9504495a43e21f5b344c462d5e79e9f1416484f359a0cc56ac0a1bae8445144bee3a7aa7e8320b36a2703374a6441cb307430c13d0ae891b803",
            "68e7626e0f7045185945483038efd0520c05ff5179f8e0090ae86317718fa4f09666f7609b365a72bb82e655242c3fdb7c9aa86c9de78346fc62a92a8bc421c9aaef15bf786b09035a8d95de21c38a56a5e01dd2308ef2b949aa89c8a53c3d1d8e609ac6e026a8f9eb79d597983a2b519b24cbce415c74947893",
            "a0c6fc1db0926f2ec72fc115bb4f8ff217c356a2752c1c0ef4195e1c5312ab0d23e2535cffc6bd4a0c9f002c753b05ac313888a81021e52c248cebf3c566639b6e82755d6abd1da2b4ca707812cdb9c44e4688c957c9d9c488705d0e098b41d6096d259ebde315",
        ],
    },
]


multi_frames = [
    {
        "frame": "7ea08bceff0313eee1e6e700e0400001000077db084c475a677362f13a8201c53000bebdf073749839df2e9df977dc39777ebfc3261bb4fced7247fd0a4ec005f86f170bfa426e2fc350230616b9e9996f9a74c0ed6978406acd41cbfcada91b45988abe0b89fd6087a85d289634a80e84bbee41b28528debdb97490f1ca661a068ba682d07f99b198ba288d7e7ea08bceff0313eee1e040000200007ae8759eeeedc3c62c6cd8e500f8854fedb0cd204f05f303f11911a1f2f4b35c1f8ad76791b7c78a222b4982fc17acabbf506da15911d47f214c04b08b71ac3f6f2c88fba207dd339cbd1ce4466b40e28c0e6fb525514c34f26e7a950a9be509df7f52b9d4935779848c1dc75a5ccd437b0ef35e94c4ba10c7649593187e7ea08bceff0313eee1e040000300007a209284d8d63a2e47284451751e4f98bec8dece429791b907e38164558dab06ab2b43e9c8fb6eb6a51028aaecf248916e62f04f3de0e630ed805cb764ff351b753bd00fbf321e753af60062253f78c3db8da7df1c356837938c0b7d636992cd33a091e162b3915d189a8b2da33a543c3772b671104fc8d54a859e1a0b7e7ea078ceff03138463e0c00004000067a88bee1dc368db60c2102ba8fde549b61e042f993d843358c584dc5cec70b0b707285697b23b95bd111babb29b432d964e4992cd65faf6a157839764850846dd780413e7c4152b431752d191ff7ada7e4aef575d07299651d7f5ee0e8e099eebeddd3da34ddbc687aa7e",
        "encryption_key": "00000000000000000000000000000000",
        "auth_key": "00000000000000000000000000000000",
        "payload": "db084c475a677362f13a8201c53000bebdf073749839df2e9df977dc39777ebfc3261bb4fced7247fd0a4ec005f86f170bfa426e2fc350230616b9e9996f9a74c0ed6978406acd41cbfcada91b45988abe0b89fd6087a85d289634a80e84bbee41b28528debdb97490f1ca661a068ba682d07f99b198bae8759eeeedc3c62c6cd8e500f8854fedb0cd204f05f303f11911a1f2f4b35c1f8ad76791b7c78a222b4982fc17acabbf506da15911d47f214c04b08b71ac3f6f2c88fba207dd339cbd1ce4466b40e28c0e6fb525514c34f26e7a950a9be509df7f52b9d4935779848c1dc75a5ccd437b0ef35e94c4ba10c76495209284d8d63a2e47284451751e4f98bec8dece429791b907e38164558dab06ab2b43e9c8fb6eb6a51028aaecf248916e62f04f3de0e630ed805cb764ff351b753bd00fbf321e753af60062253f78c3db8da7df1c356837938c0b7d636992cd33a091e162b3915d189a8b2da33a543c3772b671104fc8d54a859ea88bee1dc368db60c2102ba8fde549b61e042f993d843358c584dc5cec70b0b707285697b23b95bd111babb29b432d964e4992cd65faf6a157839764850846dd780413e7c4152b431752d191ff7ada7e4aef575d07299651d7f5ee0e8e099eebeddd3da34ddbc6",
        "apdu": "0f00bebe620c07e70b1e040e2e23ff80000002120112020412002809060008190900ff0f02120000020412002809060008190900ff0f01120000020412000109060000600100ff0f02120000020412000809060000010000ff0f02120000020412000309060100010700ff0f02120000020412000309060100020700ff0f02120000020412000309060100010800ff0f02120000020412000309060100020800ff0f02120000020412000309060100030700ff0f02120000020412000309060100040700ff0f02120000020412000309060100030800ff0f02120000020412000309060100040800ff0f021200000204120003090601001f0700ff0f02120000020412000309060100330700ff0f02120000020412000309060100470700ff0f02120000020412000309060100200700ff0f02120000020412000309060100340700ff0f02120000020412000309060100480700ff0f0212000009060008190900ff09083536383135393330090c07e70b1e040e2e23ff80000106000000050600000000060000c2a00600000000060000000006000000000600001259060000e39b1200041200001200001200ea120000120000",
    },
    {
        "frame": "7ea08bceff0313eee1e6e700e0400001000077db084c475a677362f13a8201c53000b1cdb52ec1eb626fde9e6d337047190e0cb1ca7f6d681d0dbede752c685dadf86382cf4ea66bb1890e11fdb1eb87090db5fc451603362da0ce529e57cb0be9e3af314e61ef3c3ea7ec236dcc3846bacd3256c98a220165fcc30696c7a8a3b44114b87c816b760d420ae57e"
        "7ea08bceff0313eee1e040000200007a474c319e92d674b21117089bb4c52b7cc551eaf3052a2892fcdd95c48bedf90d5d521cfe4b3cc4f3b974c865d9116d5208e19831d869db3a1d6609e4a54c43c9b9504495a43e21f5b344c462d5e79e9f1416484f359a0cc56ac0a1bae8445144bee3a7aa7e8320b36a2703374a6441cb307430c13d0ae891b80307197e"
        "7ea08bceff0313eee1e040000300007a68e7626e0f7045185945483038efd0520c05ff5179f8e0090ae86317718fa4f09666f7609b365a72bb82e655242c3fdb7c9aa86c9de78346fc62a92a8bc421c9aaef15bf786b09035a8d95de21c38a56a5e01dd2308ef2b949aa89c8a53c3d1d8e609ac6e026a8f9eb79d597983a2b519b24cbce415c74947893a5257e"
        "7ea078ceff03138463e0c00004000067a0c6fc1db0926f2ec72fc115bb4f8ff217c356a2752c1c0ef4195e1c5312ab0d23e2535cffc6bd4a0c9f002c753b05ac313888a81021e52c248cebf3c566639b6e82755d6abd1da2b4ca707812cdb9c44e4688c957c9d9c488705d0e098b41d6096d259ebde315dd0d7e",
        "encryption_key": "00000000000000000000000000000000",
        "auth_key": "00000000000000000000000000000000",
        "payload": "db084c475a677362f13a8201c53000b1cdb52ec1eb626fde9e6d337047190e0cb1ca7f6d681d0dbede752c685dadf86382cf4ea66bb1890e11fdb1eb87090db5fc451603362da0ce529e57cb0be9e3af314e61ef3c3ea7ec236dcc3846bacd3256c98a220165fcc30696c7a8a3b44114b87c816b760d42474c319e92d674b21117089bb4c52b7cc551eaf3052a2892fcdd95c48bedf90d5d521cfe4b3cc4f3b974c865d9116d5208e19831d869db3a1d6609e4a54c43c9b9504495a43e21f5b344c462d5e79e9f1416484f359a0cc56ac0a1bae8445144bee3a7aa7e8320b36a2703374a6441cb307430c13d0ae891b80368e7626e0f7045185945483038efd0520c05ff5179f8e0090ae86317718fa4f09666f7609b365a72bb82e655242c3fdb7c9aa86c9de78346fc62a92a8bc421c9aaef15bf786b09035a8d95de21c38a56a5e01dd2308ef2b949aa89c8a53c3d1d8e609ac6e026a8f9eb79d597983a2b519b24cbce415c74947893a0c6fc1db0926f2ec72fc115bb4f8ff217c356a2752c1c0ef4195e1c5312ab0d23e2535cffc6bd4a0c9f002c753b05ac313888a81021e52c248cebf3c566639b6e82755d6abd1da2b4ca707812cdb9c44e4688c957c9d9c488705d0e098b41d6096d259ebde315",
        "apdu": "0f00b1ce270c07e70a0c040e0528ff80000002120112020412002809060008190900ff0f02120000020412002809060008190900ff0f01120000020412000109060000600100ff0f02120000020412000809060000010000ff0f02120000020412000309060100010700ff0f02120000020412000309060100020700ff0f02120000020412000309060100010800ff0f02120000020412000309060100020800ff0f02120000020412000309060100030700ff0f02120000020412000309060100040700ff0f02120000020412000309060100030800ff0f02120000020412000309060100040800ff0f021200000204120003090601001f0700ff0f02120000020412000309060100330700ff0f02120000020412000309060100470700ff0f02120000020412000309060100200700ff0f02120000020412000309060100340700ff0f02120000020412000309060100480700ff0f0212000009060008190900ff09083536383135393330090c07e70a0c040e0528ff80008106000000000600000000060000c28d0600000000060000000006000000000600001259060000e39b1200001200001200001200ea120000120000",
    },
    {
        "frame": "7ea08bceff0313eee1e6e700e0400001000077db084c475a677362f13a8201c53000bebd3e2ba5514b2faf33ede300769ac5296935603e9fd682e3d6b489e044528490e1c164dcc7a04cba50e543e87ea48a76f32fc2d9e390e553426eb569ec55322a043a34fc503684dd0cec4281814e8b64719874f0616be2db84903ffde0e08b537110db863f2ded10be7e7ea08bceff0313eee1e040000200007a89be2533a6a94e8946e94be3c05ab22bdd5a7925b63395476ba1e263a5aee6d44ef90d35ac5d80b2cf102e7a1a7b38a5ed226c00a4a6a07c6297a5bd5bf38e5c44352713e245454b462ae7060cc436cd345288d8ad8ca4fb9ef0c0e11018d17630c40225374cbdf8aebcdeec1ae4fe0fd2ccb104d90936127064d9ad7e7ea08bceff0313eee1e040000300007aeaaa2c9434654e3964f21e415233e40eef3987db08939d2a8039bdc663a64147a29e492f1ce64f0fc9649127deeddd5659f56aaeb4eff49e789396b81ab31c18ad60c1c5ac71c523537f045b363f0580dcaff4700bf2ea56ef76591dcb32b48183109ccb6f2b012e6e9df02bec11aa41ceee7f60c1a41b513b32f7cc7e7ea078ceff03138463e0c00004000067fe28b19de13717626a7d23c9e5dcc2532b2dab2215dfb5b45d4cc809173753afa284a39a671808d7fb13a3f6a0db339fc81446db65815b113f4a4682ded36ce26a9647d7b9274e926923f075b792017c61ae4c028dc36df3aee23a78f10269beec0bd129b6032344507e",
        "encryption_key": "00000000000000000000000000000000",
        "auth_key": "00000000000000000000000000000000",
        "payload": "db084c475a677362f13a8201c53000bebd3e2ba5514b2faf33ede300769ac5296935603e9fd682e3d6b489e044528490e1c164dcc7a04cba50e543e87ea48a76f32fc2d9e390e553426eb569ec55322a043a34fc503684dd0cec4281814e8b64719874f0616be2db84903ffde0e08b537110db863f2ded89be2533a6a94e8946e94be3c05ab22bdd5a7925b63395476ba1e263a5aee6d44ef90d35ac5d80b2cf102e7a1a7b38a5ed226c00a4a6a07c6297a5bd5bf38e5c44352713e245454b462ae7060cc436cd345288d8ad8ca4fb9ef0c0e11018d17630c40225374cbdf8aebcdeec1ae4fe0fd2ccb104d90936127064eaaa2c9434654e3964f21e415233e40eef3987db08939d2a8039bdc663a64147a29e492f1ce64f0fc9649127deeddd5659f56aaeb4eff49e789396b81ab31c18ad60c1c5ac71c523537f045b363f0580dcaff4700bf2ea56ef76591dcb32b48183109ccb6f2b012e6e9df02bec11aa41ceee7f60c1a41b513b32fe28b19de13717626a7d23c9e5dcc2532b2dab2215dfb5b45d4cc809173753afa284a39a671808d7fb13a3f6a0db339fc81446db65815b113f4a4682ded36ce26a9647d7b9274e926923f075b792017c61ae4c028dc36df3aee23a78f10269beec0bd129b60323",
        "apdu": "0f00bebdb00c07e70b1e040e1f2dff80000002120112020412002809060008190900ff0f02120000020412002809060008190900ff0f01120000020412000109060000600100ff0f02120000020412000809060000010000ff0f02120000020412000309060100010700ff0f02120000020412000309060100020700ff0f02120000020412000309060100010800ff0f02120000020412000309060100020800ff0f02120000020412000309060100030700ff0f02120000020412000309060100040700ff0f02120000020412000309060100030800ff0f02120000020412000309060100040800ff0f021200000204120003090601001f0700ff0f02120000020412000309060100330700ff0f02120000020412000309060100470700ff0f02120000020412000309060100200700ff0f02120000020412000309060100340700ff0f02120000020412000309060100480700ff0f0212000009060008190900ff09083536383135393330090c07e70b1e040e1f2dff80000106000000050600000000060000c29f0600000000060000000006000000000600001259060000e39b1200041200001200001200ea120000120000",
    },
]


def test_multi_frame():

    for multi_frame in multi_frames:
        dec_key_bytes = (bytes.fromhex(multi_frame["encryption_key"]),)
        auth_key_bytes = (bytes.fromhex(multi_frame["auth_key"]),)
        extracted_frames = MbusReader.extract_frames(bytearray.fromhex(multi_frame["frame"]))
        total_payload = bytearray()
        for ext_frame in extracted_frames:
            dlms_frame = DLMSFrame(ext_frame)
            assert len(ext_frame) - 2 == dlms_frame.length
            total_payload.extend(dlms_frame.get_payload())
        print(f"total payload: {total_payload.hex()}")
        assert multi_frame["payload"] == total_payload.hex()

        apdu = decrypt_gcm(auth_key_bytes[0], total_payload.hex(), dec_key_bytes[0])
        print(f"apdu: {apdu}")
        assert multi_frame["apdu"] == apdu
        obis_dlms = apdu
        data = parse_e450_meter_data(obis_dlms)

        data_str = json.dumps(data, indent=2)
        print(data_str)
        assert type(data_str) == str


@pytest.mark.skip(reason="CRC computation does not work right now")
def test_parse_frames():
    for frame in frames:
        extracted_frames = MbusReader.extract_frames(bytearray.fromhex(frame))
        for ext_frame in extracted_frames:
            dlms_frame = DLMSFrame(ext_frame)
            assert len(ext_frame) - 2 == dlms_frame.length
            print(dlms_frame.get_payload_hex())
            assert dlms_frame.verify_checksum()
    assert False


def test_read_frames():
    for frame_data in frames_data:
        print(f"frame: {frame_data}")
        extracted_frames = MbusReader.extract_frames(bytearray.fromhex(frame_data["frame"]))

        assert frame_data["num_frames"] == len(extracted_frames)
        index = 0
        for ext_frame in extracted_frames:
            print(f"ext frame {ext_frame.hex()}")
            dlms_frame = DLMSFrame(ext_frame)
            assert len(ext_frame) - 2 == dlms_frame.length
            data = dlms_frame.get_payload()
            assert data != None
            assert frame_data["length"][index] == len(data)
            assert frame_data["data"][index] == data.hex()
            index = index + 1
